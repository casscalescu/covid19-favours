<div class="main-container">
  <%= simple_form_for :query, url: favours_path, method: "GET" do |f| %>
    <%= f.input :location, placeholder: 'Search by location...', input_html: {value: "", class: "search"} %>
    <%# f.submit "Search", class: "primary-button" %>
  <% end %>

  <%= "No favours nearby..." unless @nearby_favours %>

  <div class="grid">
  <% @open_favours.each do |favour| %>
    <div class="favour-card favour-card--shadow js-favour-index-card"
      data-toggle="modal"
      data-target="#favourIndexModal"
      data-favour-recipient-photo="<%= favour.recipient.photo.key %>"
      data-favour-recipient-name="<%= favour.recipient.first_name %>"
      data-favour-completion="<%= favour.completion_date %>"
      data-favour-category="<%= favour.category %>"
      data-favour-title="<%= favour.title %>"
      data-favour-description="<%= favour.description %>"
    >

      <!-- Favour Category -->
      <div class="category favour-card__category
        <% case favour.category %>
          <% when "Groceries" %>
            category--type--groceries category--fill-orange
          <% when "Pets" %>
            category--type--pets category--fill-light-blue
          <% when "Gardening" %>
            category--type--gardening category--fill-green
          <% when "Medicine" %>
            category--type--pharmacy category--fill-dark-blue
          <% when "Other" %>
            category--type--other category--fill-red
          <% when "Friendly Chat" %>
            category--type--chat category--fill-yellow
        <% end %>
      ">
        <div class="category__circle">
          <img class="category__icon">
        </div>
      </div>

      <!-- Header -->
      <div class="favour-card__header">
        <!-- Favour User -->
        <%= cl_image_tag(favour.recipient.photo.key, crop: :thumb, gravity: :face, width: 500, height: 500, class: "avatar favour-card__avatar") %>
        <!-- Favour Completion -->
        <div class="pill favour-card__pill pill--outline-black"><%= favour.completion_date.to_formatted_s(:rfc822) %></div>
      </div>

      <!-- Card content -->
      <h3 class="favour-card__title">
        <%= favour.title %>
      </h3>
      <div class="location favour-card__location">
        <img class="location__icon">
        <p class="location__address"><%= favour.address %></p>
      </div>
      <p class="favour-card__description">
        <%= truncate(favour.description, :length => 160) %>
      </p>


      <!-- Favour buttons -->
      <% if user_signed_in? %>
        <!-- Apply for favour -->
        <% unless current_user.applied?(favour) || favour.recipient == current_user %>
          <button class="button favour-card__button button--primary-fill">
            <%= link_to "Help out", new_favour_favour_application_path(favour) %>
          </button>
        <% end %>
        <!-- Already applied for favour -->
        <% if current_user.applied?(favour) %>
          <!-- Pending -->
          <% if current_user.application_status(favour) == "Pending" %>
            <p class="favour-card__notice">You've already applied!</p>
            <!-- Withdraw -->
            <%= simple_form_for [favour, favour.favour_applications.where(applicant: current_user).take] do |f| %>
              <%= f.hidden_field :status, value: "Withdrawn" %>
              <button class="button favour-card__button button--primary-fill">
                <%= f.button :submit, 'Withdraw' %>
              </button>
            <% end %>
          <!-- Applied and withdrawn -->
          <% elsif current_user.application_status(favour) == "Withdrawn" %>
            <p class="favour-card__notice favour-card__notice--index">You've withdrawn your application</p>
          <!-- Applied and rejected -->
          <% elsif current_user.application_status(favour) == "Rejected" %>
            <p class="favour-card__notice favour-card__notice--index">Your application was rejected</p>
          <% end %>
        <% end %>
        <!-- Edit favour -->
        <% if favour.recipient == current_user %>
          <% if favour.favour_applications.empty? %>
            <button class="button favour-card__button button--primary-fill">
              <%= link_to "Edit", edit_favour_path(favour) %>
            </button>
          <% else %>
          <!-- View application -->
            <button class="button favour-card__button button--primary-fill">
              <%= link_to "View Applications", favour_favour_applications_path(favour) %>
\            </button>
          <% end %>
        <% end %>
      <!-- Apply button for users not signed in (redirects to sign in page first) -->
      <% else %>
        <button class="button favour-card__button button--primary-fill">
          <%= link_to "Help out", new_favour_favour_application_path(favour) %>
        </button>
      <% end %>
    </div>
  <% end %>
  </div>
</div>

<!-- Modal -->
<%= render "favour-index-modal" %>
