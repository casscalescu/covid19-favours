<div class="main-container">
  <!-- Own Favours -->
  <div class="dashboard-tabs">
    <h1>Your Favours</h1>
    <div class="dashboard-tabs__labels">
      <a data-tab-id="1" class="dashboard-tabs__label">Accepted</a>
      <a data-tab-id="2" class="dashboard-tabs__label active">Open</a>
      <a data-tab-id="3" class="dashboard-tabs__label">Archived</a>
    </div>
    <div data-tab-id="1" class="dashboard-tabs__content">
      <div class="grid">
        <% @helper_accepted.each do |favour| %>
          <div class="favour-card favour-card--outline">
            <!-- Favour Category -->
            <div class="category category--outline-black favour-card__category
              <% case favour.category %>
                <% when "Groceries" %>
                  category--type--groceries
                <% when "Pets" %>
                  category--type--pets
                <% when "Gardening" %>
                  category--type--gardening
                <% when "Medicine" %>
                  category--type--pharmacy
                <% when "Other" %>
                  category--type--other
                <% when "Chat" %>
                  category--type--chat
              <% end %>">
              <div class="category__circle">
                <img class="category__icon">
              </div>
            </div>

            <!-- Header -->
            <div class="favour-card__header">
              <!-- Favour User -->
              <%= cl_image_tag(favour.recipient.photo.key, crop: :thumb, gravity: :face, width: 500, height: 500, class: "avatar favour-card__avatar") %>
              <!-- Favour Completion -->
              <% if favour.completion_asap == 'true' %>
                <div class="pill favour-card__pill pill--fill-light-blue">ASAP</div>
              <% else %>
                <div class="pill favour-card__pill pill--fill-light-blue"><%= favour.completion_date.to_formatted_s(:rfc822) %></div>
              <% end %>
            </div>

            <!-- Card content -->
            <h3 class="favour-card__title">
              <%= favour.title %>
            </h3>
            <div class="location favour-card__location">
              <img class="location__icon">
              <p class="location__address"><%= favour.address %></p>
            </div>
            <p class="favour-card__description">
              <%= truncate(favour.description, :length => 200) %>
            </p>

            <!-- Favour buttons -->
            <% if user_signed_in? %>
              <!-- Apply for favour -->
              <% unless current_user.applied?(favour) || favour.recipient == current_user %>
                <%= link_to "Help out", new_favour_favour_application_path(favour), class: "button favour-card__button button--primary-fill" %>
              <% end %>
              <!-- Already applied for favour -->
              <% if current_user.applied?(favour) %>
                <!-- Pending -->
                <% if current_user.application_status(favour) == "Pending" %>
                  <p class="favour-card__notice">You've submitted a request to help</p>
                  <!-- Withdraw -->
                  <%= simple_form_for [favour, favour.favour_applications.where(applicant: current_user).take] do |f| %>
                    <%= f.hidden_field :status, value: "Withdrawn" %>
                    <%= button_tag(type: "submit", class: 'button favour-card__button button--primary-fill') do %>
                      Withdraw
                    <% end %>
                  <% end %>
                <!-- Applied and withdrawn -->
                <% elsif current_user.application_status(favour) == "Withdrawn" %>
                  <p class="favour-card__notice favour-card__notice--index">You've withdrawn your application</p>
                <!-- Applied and rejected -->
                <% elsif current_user.application_status(favour) == "Rejected" %>
                  <p class="favour-card__notice favour-card__notice--index">Your request to help was declined</p>
                <% end %>
              <% end %>
              <% if favour.recipient == current_user %>
                <% if favour.applicants_applied? %>
                  <!-- View applicants -->
                  <%= link_to "View Applicants", favour_favour_applications_path(favour), class: "button favour-card__button button--primary-fill" %>
                <% else %>
                  <!-- Edit favour -->
                  <%= link_to "Edit", edit_favour_path(favour), class: "button favour-card__button button--primary-fill" %>
                <% end %>
              <% end %>
            <!-- Apply button for users not signed in (redirects to sign in page first) -->
            <% else %>
              <%= link_to "Help out", new_favour_favour_application_path(favour), class: "button favour-card__button button--primary-fill" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    <div data-tab-id="2" class="dashboard-tabs__content active">
      <p>Own - Open</p>
    </div>
    <div data-tab-id="3" class="dashboard-tabs__content">
      <p>Own - Archived</p>
    </div>
  </div>
  <!-- Other's Favours -->
  <div class="dashboard-tabs">
    <h1>Favours You're Doing</h1>
    <div class="dashboard-tabs__labels">
      <a data-tab-id="1" class="dashboard-tabs__label">Accepted</a>
      <a data-tab-id="2" class="dashboard-tabs__label active">Open</a>
      <a data-tab-id="3" class="dashboard-tabs__label">Archived</a>
    </div>
    <div data-tab-id="1" class="dashboard-tabs__content">
      <p>Others - Accepted</p>
    </div>
    <div data-tab-id="2" class="dashboard-tabs__content active">
      <p>Others - Open</p>
    </div>
    <div data-tab-id="3" class="dashboard-tabs__content">
      <p>Others - Archived</p>
    </div>
  </div>
  <br>
  <br>
  <br>
  <h1>Skeleton Dashboard</h1>
  <!-- User as a helper -->
  <% if current_user.helper? %>
    <div class="helper-favours">
      <div class="accepted-favours">
        <h4>Accepted Favours</h4>
        <% @helper_accepted.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <p><%= favour.recipient.mobile %></p>
          </div>
        <% end %>
      </div>
      <div class="open-favours">
        <h4>Applied Favours</h4>
        <% @helper_open.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <%= simple_form_for [favour, favour.favour_applications.where(applicant: current_user).take] do |f| %>
              <%= f.hidden_field :status, value: "Withdrawn" %>
              <%= f.button :submit, 'Withdraw Application', class: "btn btn-primary" %>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="archived-favours">
        <h4>Archived Favours</h4>
        <% @helper_archived.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.status %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <!-- User as a recipient -->
  <% if current_user.recipient? %>
    <div class="recipient-favours">
      <div class="accepted-favours">
        <h4>Accepted Favours</h4>
        <% @recipient_accepted.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.helper.first_name %></p>
            <%= cl_image_tag(favour.helper.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <p><%= favour.helper.mobile %></p>
          </div>
        <% end %>
      </div>
      <div class="open-favours">
        <h4>Open Favours</h4>
        <% @recipient_open.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <% if favour.favour_applications.empty? %>
              <%= link_to "Edit Favour", edit_favour_path(favour), class: 'btn btn-primary' %>
            <% else %>
              <%= link_to "View Applications (#{favour.favour_applications.count})", favour_favour_applications_path(favour), class: 'btn btn-primary' %>
            <% end %>
            </ul>
          </div>
        <% end %>
      </div>
      <div class="archived-favours">
        <h4>Archived Favours</h4>
        <% @recipient_archived.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.status %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.helper.first_name %></p>
            <p><%= favour.helper.mobile %></p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <!-- Review notification -->
  <!-- User as a helper -->
  <% if current_user.helper? %>
    <% @helper_done_favours.each do |favour| %>
      <% unless favour.reviews.where(subject: "Recipient").exists? %>
        <div class="card">
          <p>Favour: <%= favour.title %></p>
          <p>You completed a favour for: <%= link_to favour.recipient.first_name, user_path(favour.recipient) %></p>
          <%= link_to "Review", new_favour_review_path(favour), class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  <% end %>
  <!-- User as a recipient -->
  <% if current_user.recipient? %>
    <% @recipient_done_favours.each do |favour| %>
      <% unless favour.reviews.where(subject: "Helper").exists? %>
        <div class="card">
          <p>Favour: <%= favour.title %></p>
          <p>Completed by: <%= link_to favour.helper.first_name, user_path(favour.helper) %></p>
          <%= link_to "Review", new_favour_review_path(favour), class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  <% end %>
  <!-- Favour about to expire notification -->
  <% unless @recipient_favours_expiring.empty? %>
    <h4>Favours about to expire:</h4>
    <% @recipient_favours_expiring.each do |favour| %>
      <div class="card">
        <%= link_to "#{favour.title}", favour_path(favour) %>
        <%= render 'favours/edit-date', favour: favour %>
      </div>
    <% end %>
  <% end %>
</div>
