<div class="container">
  <div class="dashboard-section your-favours">
    <h1>Your Favours</h1>
    <div class="tabs">
      <a data-tab-id="1" class="tab-label">Accepted</a>
      <a data-tab-id="2" class="tab-label active">Open</a>
      <a data-tab-id="3" class="tab-label">Archived</a>
    </div>
    <div data-tab-id="1" class="tab-content">
    </div>
    <div data-tab-id="2" class="tab-content active">
      <% @recipient_open.each do |favour| %>
        <div class="dashboard-card">
          <div class="dashboard-header">
            <!-- Favour User -->
            <%= cl_image_tag(favour.recipient.photo.key, width: 80, height: 80, crop: :thumb, gravity: :face, class: "dashboard-card-user-image") %>
            <!-- Favour Completion -->
            <div class="dashboard-card-completion-date"><%= favour.completion_date.to_formatted_s(:rfc822) %></div>
            <!-- Favour Category -->
            <% case favour.category %>
              <% when "Groceries" %>
                <%= render "shared/groceries-icon" %>
              <% when "Pets" %>
                <%= render "shared/pets-icon" %>
              <% when "Gardening" %>
                <%= render "shared/gardening-icon" %>
              <% when "Medicine" %>
                <%= render "shared/medicine-icon" %>
              <% when "Other" %>
                <%= render "shared/other-icon" %>
            <% end %>
          </div>
          <!-- Favour Content -->
          <div class="dashboard-card-content">
            <h4><%= favour.title %></h4>
            <p><%= favour.description %></p>
          </div>
          <!-- Favour buttons -->
          <div class="dashboard-card-footer">
            <% if user_signed_in? %>
              <!-- Apply for favour -->
              <% unless current_user.applied?(favour) || favour.recipient == current_user %>
                <%= link_to "Help out", new_favour_favour_application_path(favour), class: 'primary-button float-right' %>
              <% end %>
              <!-- Already applied for favour -->
              <% if current_user.applied?(favour) %>
                <!-- Applied and pending -->
                <% if current_user.application_status(favour) == "Pending" %>
                  <p class="badge float-right">You've already applied!</p>
                  <%= simple_form_for [favour, favour.favour_applications.where(applicant: current_user).take] do |f| %>
                    <%= f.hidden_field :status, value: "Withdrawn" %>
                    <%= f.button :submit, 'Withdraw', class: "primary-button float-right" %>
                  <% end %>
                <!-- Applied and withdrawn -->
                <% elsif current_user.application_status(favour) == "Withdrawn" %>
                  <p class="badge badge-warning">You've withdrawn your application</p>
                <!-- Applied and rejected -->
                <% elsif current_user.application_status(favour) == "Rejected" %>
                  <p class="badge badge-warning">Your application was rejected</p>
                <% end %>
              <% end %>
              <!-- Edit favour -->
              <% if favour.recipient == current_user %>
                <% if favour.favour_applications.empty? %>
                  <%= link_to "Edit", edit_favour_path(favour), class: 'primary-button float-right' %>
                <% else %>
                  <%= link_to "View Applications", favour_favour_applications_path(favour), class: 'primary-button float-right' %>
                <% end %>
              <% end %>
            <!-- Apply button for users not signed in (redirects to sign in page first) -->
            <% else %>
              <%= link_to "Help out", new_favour_favour_application_path(favour), class: 'primary-button float-right' %>
            <% end %>
          </div>
        </div>
      <% end %>
      </div>
    </div>
    <div data-tab-id="3" class="tab-content">
      <p>Archived Cards...</p>
      <p>Archived Cards...</p>
      <p>Archived Cards...</p>
      <p>Archived Cards...</p>
    </div>
  </div>
</div>
<br>
<br>
<br>
<h1>Skeleton Dashboard</h1>

<!-- Review notification -->
<div class="container">
  <!-- User as a helper -->
  <% if current_user.helper? %>
    <% @helper_done_favours.each do |favour| %>
      <% unless favour.reviews.where(subject: "Helper").exists? %>
        <div class="card">
          <p>Favour: <%= favour.title %></p>
          <p>You completed a favour for: <%= link_to favour.recipient.first_name, user_path(favour.recipient) %></p>
          <%= link_to "Review", new_favour_review_path(favour), class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  <% end %>
  <!-- User as a recipient -->
  <% if current_user.recipient? %>
    <% @recipient_done_favours.each do |favour| %>
      <% unless favour.reviews.where(subject: "Recipient").exists? %>
        <div class="card">
          <p>Favour: <%= favour.title %></p>
          <p>Completed by: <%= link_to favour.helper.first_name, user_path(favour.helper) %></p>
          <%= link_to "Review", new_favour_review_path(favour), class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>

<!-- Favour about to expire notification -->
<% unless @recipient_favours_expiring.empty? %>
  <div class="container">
    <h4>Favours about to expire:</h4>
    <% @recipient_favours_expiring.each do |favour| %>
      <div class="card">
        <%= link_to "#{favour.title}", favour_path(favour) %>
        <%= render 'favours/edit-date', favour: favour %>
      </div>
    <% end %>
  </div>
<% end %>

<!-- Dashboard -->
<div class="container">
  <!-- User as a helper -->
  <% if current_user.helper? %>
    <div class="helper-favours">
      <div class="accepted-favours">
        <h4>Accepted Favours</h4>
        <% @helper_accepted.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <p><%= favour.recipient.mobile %></p>
          </div>
        <% end %>
      </div>
      <div class="open-favours">
        <h4>Applied Favours</h4>
        <% @helper_open.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <%= simple_form_for [favour, favour.favour_applications.where(applicant: current_user).take] do |f| %>
              <%= f.hidden_field :status, value: "Withdrawn" %>
              <%= f.button :submit, 'Withdraw Application', class: "btn btn-primary" %>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="archived-favours">
        <h4>Archived Favours</h4>
        <% @helper_archived.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.status %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.recipient.first_name %></p>
            <%= cl_image_tag(favour.recipient.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <!-- User as a recipient -->
  <% if current_user.recipient? %>
    <div class="recipient-favours">
      <div class="accepted-favours">
        <h4>Accepted Favours</h4>
        <% @recipient_accepted.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.helper.first_name %></p>
            <%= cl_image_tag(favour.helper.photo.key, width: 150, height: 150, crop: :thumb, gravity: :face) %>
            <p><%= favour.helper.mobile %></p>
          </div>
        <% end %>
      </div>
      <div class="open-favours">
        <h4>Open Favours</h4>
        <% @recipient_open.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <% if favour.favour_applications.empty? %>
              <%= link_to "Edit Favour", edit_favour_path(favour), class: 'btn btn-primary' %>
            <% else %>
              <%= link_to "View Applications (#{favour.favour_applications.count})", favour_favour_applications_path(favour), class: 'btn btn-primary' %>
            <% end %>
            </ul>
          </div>
        <% end %>
      </div>
      <div class="archived-favours">
        <h4>Archived Favours</h4>
        <% @recipient_archived.each do |favour| %>
          <div class="card">
            <%= link_to "#{favour.title}", favour_path(favour) %>
            <p><%= favour.completion_date %></p>
            <p><%= favour.status %></p>
            <p><%= favour.description %></p>
            <p><%= favour.address %></p>
            <p><%= favour.helper.first_name %></p>
            <p><%= favour.helper.mobile %></p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
